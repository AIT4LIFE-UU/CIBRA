---
title: "Genome wide screen using CIBRA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Genome wide screen using CIBRA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
    message=FALSE, 
  warning=FALSE
)
```

Similar to determining the impact of a single alterations as shown in vignette: impact_assessment_genomic_alteration, a genome-wide screen only needs a more extensive definition matrix.
In this example we will showcase a more extensive exploration of the definition matrix. However due to the computational time, we will limit ourself only to 6 genes instead of genome-wide.

```{r setup}
# load functions
library(CIBRA)
library(BiocParallel)
```

```{r data}
# load transcription data and genomic alterations
count_data <- CIBRA::TCGA_CRC_rna_data
definition_matrix <- CIBRA::TCGA_CRC_non_silent_mutation_profile
```


We will make use of the whole definition matrix, which consist of the mutation status of every protein coding gene measured in the TCGA.

```{r prepare data}
# prepare data for CIBRA

# fix sample names for intersect between the two datatypes
rownames(definition_matrix) <- stringr::str_replace_all(rownames(definition_matrix), "-", ".")

# select intersect between definition matrix and count data
sample_list <- intersect(rownames(definition_matrix), colnames(count_data))

# select data and definition matrix as the intersect
count_data <- count_data[sample_list]
definition_matrix <- definition_matrix[sample_list,]

# optional to visualize datafrane
#if (!require("DT")) install.packages('DT')
#DT::datatable(definition_matrix)
```

To lower the computational time, we will only select 6 genes to assess in our screen. You can remove this limitation by providing the column names of the definition matrix.

```{r parameters}
# focus on a subset of the genes, for the genome-wide screen you can replace this line with columns = colnames(definition_matrix)
columns <- c("APC", "TP53", "KRAS", "BRAF", "PIK3CA", "TTN")

# set up parameters for CIBRA
control_definition <- "WT" # reference condition
confidence <- 0.1 # confidence threshold for the proportion calculation
# set permutation to 0 to skip permutations
iterations = 0 # number of permutation iterations to be performed per condition

register(SnowParam(4)) # set number of cores to be used
```

```{r run CIBRA}
# run CIBRA
CIBRA_res <- run_CIBRA(count_data, as.data.frame(definition_matrix), columns, 
                       control_definition, confidence, iterations, 
                       parallel = TRUE)
```

```{r report results}
# print the report table
knitr::kable(CIBRA_res$CIBRA_results, format = "html")
```

```{r permutation test}
# calculate the pvalue by comparing to a reference distribution
perm_data <- CIBRA::perm_dist_crc_tcga

# use the gamma test to also calculate a fitted p-value
CIBRA_res_stat <-  permutation_test(CIBRA_res$CIBRA_results, perm_data, test = "gamma")

# print the report table
knitr::kable(CIBRA_res_stat$results, format = "html")
```
